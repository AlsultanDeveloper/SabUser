rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if user is admin (reads from admins collection)
    function isUserAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
    }

    // Admins collection - authenticated users can read admin status
    match /admins/{adminId} {
      // Allow read for authenticated users to check admin status
      allow read: if request.auth != null;

      // Allow write for existing admins
      allow write: if request.auth != null && isUserAdmin();
      
      // TEMPORARY: Allow specific user to create their own admin document
      allow create: if request.auth != null && 
        request.auth.uid == 'KATVNw7VXXPAwZauqsWh5Slubu42';
    }

    // Users collection - CRITICAL FOR OAUTH
    match /users/{userId} {
      // Anyone authenticated can read
      allow read: if request.auth != null;
      
      // Users can create their own document (Apple/Google Sign-In)
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Users can update their own data, admins can update anyone
      allow update: if request.auth != null && 
        (request.auth.uid == userId || isUserAdmin());
      
      // Only admins can delete
      allow delete: if request.auth != null && isUserAdmin();
      
      // Sub-collections
      match /addresses/{addressId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Push tokens - users can write their own token
    match /pushTokens/{userId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Products collection - read for all, write for admins only
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();
    }

    // Brands collection - read for all, write for admins only
    match /brands/{brandId} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();
    }

    // Categories collection - read for all, write for admins only
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();

      // Subcategories - read for all, write for admins only
      match /subcategory/{subcategoryId} {
        allow read: if true;
        allow write: if request.auth != null && isUserAdmin();
        
        // Nested subcategories
        match /subcategory/{nestedSubcategoryId} {
          allow read: if true;
          allow write: if request.auth != null && isUserAdmin();
        }
      }
    }
    
    // Subcategories collection (top-level) - read for all, write for admins only
    match /subcategories/{subcategoryId} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();
    }

    // Customers collection - read for admins, users can read their own data
    match /customers/{customerId} {
      allow read: if request.auth != null && 
        (request.auth.uid == customerId || isUserAdmin());
      allow create: if request.auth != null && request.auth.uid == customerId;
      allow update, delete: if request.auth != null && 
        (request.auth.uid == customerId || isUserAdmin());
    }

    // Orders collection - users manage own, admins manage all
    match /orders/{orderId} {
      // Allow read if user is authenticated AND (is admin OR owns the order)
      // Use request.auth.uid for list queries, resource.data.userId for individual docs
      allow list: if request.auth != null; // List will be filtered by query where('userId', '==', uid)
      allow get: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
      allow delete: if request.auth != null && isUserAdmin();
    }

    // SAB Market Orders collection - same rules as regular orders
    match /marketOrders/{orderId} {
      // Allow read if user is authenticated AND (is admin OR owns the order)
      allow list: if request.auth != null; // List will be filtered by query where('userId', '==', uid)
      allow get: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
      allow delete: if request.auth != null && isUserAdmin();
    }

    // Addresses collection
    match /addresses/{addressId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
      allow write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }

    // Cart collection
    match /carts/{userId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == userId || isUserAdmin());
    }

    // Reviews collection - read for all
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
    }

    // Admin Notifications collection - allow all for Cloud Functions
    match /notifications/{notificationId} {
      allow read, write, create, update, delete: if true;
    }

    // User Notifications collection - allow all for Cloud Functions
    match /userNotifications/{notificationId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isUserAdmin());
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create, write: if true; // Cloud Functions
      allow write: if request.auth != null && isUserAdmin();
    }

    // Activity Log collection - only admins
    match /activityLog/{logId} {
      allow read, write, create: if request.auth != null && isUserAdmin();
    }

    // Daily Stats collection - only admins
    match /dailyStats/{statsId} {
      allow read, write, create: if request.auth != null && isUserAdmin();
    }

    // Support Messages collection
    match /supportMessages/{messageId} {
      // Any user can create a support message
      allow create: if true;
      
      // Only admins can read, update, delete
      allow read, update, delete: if request.auth != null && isUserAdmin();
    }

    // Banners collection - read for all, write for admins
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();
    }

    // Settings collection - read for all, write for admins
    match /settings/{document} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();
    }

    // Suppliers/Vendors collection - read for all, write for admins only
    match /suppliers/{supplierId} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();
    }

    // ============================================
    // PHONE OTP AUTHENTICATION - تسجيل الدخول برمز التحقق
    // ============================================
    
    // Phone OTPs collection - only Cloud Functions can write
    // Users should NOT be able to read OTPs directly (security)
    match /phoneOTPs/{phoneNumber} {
      // Only Cloud Functions can create/update/delete OTPs
      // No direct read/write access for users (security measure)
      allow read, write: if false;
      
      // Cloud Functions have admin access via Admin SDK (bypasses these rules)
    }

    // ============================================
    // HR SYSTEM COLLECTIONS - نظام الموارد البشرية
    // ============================================

    // Employees collection - HR and Admins can read/write
    match /employees/{employeeId} {
      // Admins can read/write all employees
      allow read, write: if request.auth != null && isUserAdmin();
      
      // Allow public read for PIN-based employee system
      allow read: if true;
    }

    // Payrolls collection - HR and Admins can read/write, employees can read their own
    match /payrolls/{payrollId} {
      // Admins can read all payrolls
      allow read: if request.auth != null && isUserAdmin();
      
      // Employees can read their own payroll records
      allow read: if request.auth != null && 
        resource.data.employeeId == request.auth.uid;
      
      // Only admins can write
      allow write: if request.auth != null && isUserAdmin();
    }

    // Attendance collection - HR and Admins can read/write, employees can self-record
    match /attendance/{attendanceId} {
      // Admins can read/write all attendance records
      allow read, write: if request.auth != null && isUserAdmin();
      
      // Allow public read/write for employee self check-in/out
      allow read, write: if true;
    }

    // Leaves collection - HR and Admins can read/write, employees can read/write their own
    match /leaves/{leaveId} {
      // Admins can read all leave requests
      allow read: if request.auth != null && isUserAdmin();
      
      // Employees can read their own leave requests
      allow read: if request.auth != null && 
        resource.data.employeeId == request.auth.uid;
      
      // Admins can write (approve, reject, etc.)
      allow write: if request.auth != null && isUserAdmin();
      
      // Employees can create their own leave requests
      allow create: if request.auth != null && 
        request.resource.data.employeeId == request.auth.uid &&
        request.resource.data.status == 'pending';
    }

    // ============================================
    // PETTY CASH SYSTEM - نظام السلفة المالية
    // ============================================

    // Petty Cash collection - Employees can view their own, HR can manage all
    match /pettyCash/{cashId} {
      // Admins can read/write all records
      allow read, write: if request.auth != null && isUserAdmin();
      
      // Employees can read their own records (public read for PIN-based access)
      allow read: if true;
      
      // Employees can create their own advance requests (status must be 'pending')
      allow create: if request.resource.data.status == 'pending';
    }

    // ============================================
    // ASSET CUSTODY SYSTEM - نظام عهدة الأصول
    // ============================================

    // Asset Custody collection - Track company assets assigned to employees
    match /assetCustody/{custodyId} {
      // Admins can read/write all records
      allow read, write: if request.auth != null && isUserAdmin();
      
      // Employees can read their own asset custody records (public read for PIN-based access)
      allow read: if true;
    }
  }
}
