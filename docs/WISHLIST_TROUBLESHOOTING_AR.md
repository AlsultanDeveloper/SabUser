# ุงุณุชูุดุงู ูุฅุตูุงุญ ูุดุงูู ูุงุฆูุฉ ุงูุฃูููุงุช (Wishlist)

**ุงูุชุงุฑูุฎ:** 9 ููููุจุฑ 2025  
**ุงููุดููุฉ:** ุฃุฎุทุงุก ูู ุงูุตูุงุญูุงุช ุนูุฏ ูุญุงููุฉ ุงุณุชุฎุฏุงู ูุงุฆูุฉ ุงูุฃูููุงุช

## ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

```
ERROR  Error toggling wishlist: [Error: You must be logged in to perform this action]
WARN  โ๏ธ Permission denied accessing wishlists, returning empty array
WARN  โ๏ธ Permission denied creating document in wishlists
```

## ุงูุณุจุจ ุงูุฌุฐุฑู

ุงููุดููุฉ ุชุญุฏุซ ุนูุฏูุง:
1. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ูู ุณูุงู ุงูุชุทุจูู (AppContext)
2. ููู Firebase Auth ูุง ูุญุชูู ุนูู `currentUser`
3. ูุฐุง ูุนูู ุนุฏู ุชุฒุงูู ุญุงูุฉ ุงููุตุงุฏูุฉ

## ุงูุญููู ุงููุทุจูุฉ

### 1. ูุญุต ูุฒุฏูุฌ ูููุตุงุฏูุฉ โ

ุงูุขู ูุชู ูุญุต:
- ูุฌูุฏ `user` ูู ุงูุณูุงู
- ูุฌูุฏ `auth.currentUser` ูู Firebase
- ุชุทุงุจู ุงูู UID ุจููููุง

### 2. ุชุญุฏูุซ ุฑูุฒ ุงููุตุงุฏูุฉ (Token Refresh) โ

ูุจู ูู ุนูููุฉ ุนูู ูุงุฆูุฉ ุงูุฃูููุงุชุ ูุชู:
```typescript
await currentUser.getIdToken(true); // ูุฑุถ ุชุญุฏูุซ ุงูุฑูุฒ
```

### 3. ุฑุณุงุฆู ุฎุทุฃ ููุตูุฉ โ

ุงูุขู ุณุชุญุตู ุนูู ูุนูููุงุช ุชูุตูููุฉ ูู ูุญุฏุฉ ุงูุชุญูู:
```typescript
console.log('๐ Auth Debug:', {
  hasUser: !!user,
  userUid: user?.uid,
  hasCurrentUser: !!currentUser,
  currentUserUid: currentUser?.uid,
  match: user?.uid === currentUser?.uid
});
```

## ููููุฉ ุงูุชุดุฎูุต

### ุงูุฎุทูุฉ 1: ุชุญูู ูู ุณุฌูุงุช ูุญุฏุฉ ุงูุชุญูู

ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ูุงุฆูุฉ ุงูุฃูููุงุชุ ุงุจุญุซ ุนู:

```
๐ Auth Debug: {
  hasUser: true/false,
  userUid: "...",
  hasCurrentUser: true/false,
  currentUserUid: "...",
  match: true/false
}
```

### ุงูุฎุทูุฉ 2: ุชุญููู ุงููุชุงุฆุฌ

#### ุญุงูุฉ 1: `hasUser: false`
**ุงููุดููุฉ:** ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู ูู ุงูุชุทุจูู  
**ุงูุญู:** ุณุฌู ุฏุฎูู ุนุจุฑ ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู

#### ุญุงูุฉ 2: `hasUser: true` ู `hasCurrentUser: false`
**ุงููุดููุฉ:** ุนุฏู ุชุฒุงูู ุจูู ุณูุงู ุงูุชุทุจูู ู Firebase Auth  
**ุงูุญู ุงููุคูุช:**
1. ุณุฌู ุฎุฑูุฌ ูู ุงูุชุทุจูู
2. ุฃุบูู ุงูุชุทุจูู ุชูุงูุงู
3. ุงูุชุญ ุงูุชุทุจูู ูุณุฌู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู

**ุงูุญู ุงูุฏุงุฆู:** ุชุญูู ูู `AuthContext.tsx`:
```typescript
// ุชุฃูุฏ ูู ุฃู onAuthStateChanged ูุนูู ุจุดูู ุตุญูุญ
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, async (user) => {
    setState(prev => ({ ...prev, user, loading: false }));
    // ...
  });
  return () => unsubscribe();
}, []);
```

#### ุญุงูุฉ 3: `hasUser: true` ู `hasCurrentUser: true` ู `match: false`
**ุงููุดููุฉ:** ุงููุณุชุฎุฏูุงู ูุฎุชููุงู  
**ุงูุญู:**
1. ุณุฌู ุฎุฑูุฌ
2. ุงุญุฐู cache ุงูุชุทุจูู
3. ุณุฌู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู

#### ุญุงูุฉ 4: ุงููู `true` ูููู ูุง ุฒุงูุช ุงููุดููุฉ ููุฌูุฏุฉ
**ุงููุดููุฉ:** ูุดููุฉ ูู ุงูู Token  
**ุงูุญู:** ุงูุชุทุจูู ุงูุขู ูุญุฏูุซ ุงูู Token ุชููุงุฆูุงู

## ูุญุต ููุงุนุฏ Firestore

ุชุฃูุฏ ูู ุฃู ููุงุนุฏ Firestore ุตุญูุญุฉ:

```javascript
// firestore.rules
match /wishlists/{wishlistItemId} {
  allow read, delete: if request.auth != null && 
    (resource.data.userId == request.auth.uid || isUserAdmin());
  allow create: if request.auth != null && 
    request.resource.data.userId == request.auth.uid;
  allow update: if request.auth != null && 
    (resource.data.userId == request.auth.uid || isUserAdmin());
}
```

## ูุดุฑ ููุงุนุฏ Firestore

ุฅุฐุง ููุช ุจุชุนุฏูู `firestore.rules`:

```bash
# ูู PowerShell
firebase deploy --only firestore:rules
```

## ุงุฎุชุจุงุฑ ุงูุญู

### ุงุฎุชุจุงุฑ 1: ูุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู
1. ุงูุชุญ ุงูุชุทุจูู ุจุฏูู ุชุณุฌูู ุฏุฎูู
2. ุญุงูู ุฅุถุงูุฉ ููุชุฌ ููุงุฆูุฉ ุงูุฃูููุงุช
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุฑุณุงูุฉ ุชุทูุจ ููู ุชุณุฌูู ุงูุฏุฎูู ูุน ุฒุฑ ููุงูุชูุงู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู

### ุงุฎุชุจุงุฑ 2: ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู
1. ุณุฌู ุฏุฎูู ุจูุฌุงุญ
2. ุงูุชุญ ุฃู ููุชุฌ
3. ุงุถุบุท ุนูู ุฒุฑ ูุงุฆูุฉ ุงูุฃูููุงุช
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** 
   - ูู ูุญุฏุฉ ุงูุชุญูู: `โ Token refreshed successfully`
   - ูู ูุญุฏุฉ ุงูุชุญูู: `โ Added to wishlist: [productId]`
   - ุงูุฒุฑ ูุชุบูุฑ ููุธูุฑ ุฃู ุงูููุชุฌ ูู ูุงุฆูุฉ ุงูุฃูููุงุช

### ุงุฎุชุจุงุฑ 3: ุฌูุณุฉ ููุชููุฉ
1. ุณุฌู ุฏุฎูู
2. ุงูุชุธุฑ ูุชุฑุฉ ุทูููุฉ (ุฃู ุงูุณุญ ุงูู token ูุฏููุงู)
3. ุญุงูู ุงุณุชุฎุฏุงู ูุงุฆูุฉ ุงูุฃูููุงุช
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุฑุณุงูุฉ ุชุทูุจ ููู ุฅุนุงุฏุฉ ุชุณุฌูู ุงูุฏุฎูู

## ุงููููุงุช ุงููุนุฏูุฉ

1. โ๏ธ `app/search.tsx`
2. โ๏ธ `app/(tabs)/home.tsx`
3. โ๏ธ `constants/firestore.ts`

## ูุนูููุงุช ุฅุถุงููุฉ ููุชุตุญูุญ

### ูุญุต Firebase Auth ูู ุงููุชุตูุญ/ุงููุญุงูู

ุงูุชุญ React Native Debugger ุฃู ูุญุฏุฉ ุชุญูู ุงููุชุตูุญ ูุงูุชุจ:

```javascript
// ูู ูุญุฏุฉ ุงูุชุญูู
import { auth } from './constants/firebase';
console.log('Current User:', auth.currentUser);
console.log('User UID:', auth.currentUser?.uid);
console.log('Email:', auth.currentUser?.email);
```

### ูุญุต AsyncStorage

```javascript
import AsyncStorage from '@react-native-async-storage/async-storage';

AsyncStorage.getItem('user').then(user => {
  console.log('Stored user:', JSON.parse(user));
});
```

## ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

1. **ุงูุณุญ ูู ุงูุจูุงูุงุช:**
   ```bash
   # Android
   adb shell pm clear com.alsultandeveloper.sabuser
   
   # iOS
   # ุงุญุฐู ุงูุชุทุจูู ูุฃุนุฏ ุชุซุจูุชู
   ```

2. **ุชุญูู ูู Firebase Console:**
   - ุงูุชุญ [Firebase Console](https://console.firebase.google.com)
   - ุชุญูู ูู ูุณู Authentication
   - ุชุฃูุฏ ูู ูุฌูุฏ ุงููุณุชุฎุฏู

3. **ุชุญูู ูู ููุงุนุฏ Firestore:**
   - ูู Firebase Console > Firestore Database > Rules
   - ุชุฃูุฏ ูู ุฃู ุงูููุงุนุฏ ูุญุฏุซุฉ

4. **ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช:**
   - Firebase ูุญุชุงุฌ ุฅูู ุงุชุตุงู ุจุงูุฅูุชุฑูุช

## ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

### ุณ: ููุงุฐุง ูุนูู ูู ุจุนุถ ุงูุฃุญูุงู ููุง ูุนูู ูู ุฃุญูุงู ุฃุฎุฑูุ

**ุฌ:** ูุฐุง ูุญุฏุซ ุนุงุฏุฉ ุจุณุจุจ:
- ุงูุชูุงุก ุตูุงุญูุฉ ุงูู Token (ูุชู ุญููุง ุงูุขู ุชููุงุฆูุงู)
- ุนุฏู ุชุฒุงูู ุจูู `onAuthStateChanged` ู `AsyncStorage`
- ูุดุงูู ูู ุงูุดุจูุฉ

### ุณ: ูู ุฃุญุชุงุฌ ูุชุนุฏูู Firebase Rulesุ

**ุฌ:** ูุงุ ุงูููุงุนุฏ ุงูุญุงููุฉ ุตุญูุญุฉ. ุงููุดููุฉ ูุงูุช ูู ุฌุงูุจ ุงูุนููู (Client).

### ุณ: ูุงุฐุง ูู ููุช ุฃุณุชุฎุฏู Apple Sign-In ุฃู Google Sign-Inุ

**ุฌ:** ุงูุญู ูุนูู ูุน ุฌููุน ุทุฑู ุชุณุฌูู ุงูุฏุฎูู. ุงูููู ุฃู `auth.currentUser` ููุฌูุฏ.

## ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ูุดุงููุ ูุฏู ุงููุนูููุงุช ุงูุชุงููุฉ:
1. ููุทุฉ ุดุงุดุฉ ูู ุงูุฎุทุฃ
2. ุณุฌูุงุช ูุญุฏุฉ ุงูุชุญูู (ุฎุงุตุฉ ุฑุณุงุฆู `๐ Auth Debug`)
3. ุทุฑููุฉ ุชุณุฌูู ุงูุฏุฎูู ุงููุณุชุฎุฏูุฉ (Email, Google, Apple)
4. ูุธุงู ุงูุชุดุบูู (Android/iOS)
5. ูู ุงููุดููุฉ ุนูู ุงููุญุงูู ุฃู ุฌูุงุฒ ุญููููุ
